# Alembic æ•°æ®åº“è¿ç§»æŒ‡å—

æœ¬é¡¹ç›®ä½¿ç”¨Alembicè¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å’Œè¿ç§»ç®¡ç†ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

ç¡®ä¿ `.env` æ–‡ä»¶ä¸­åŒ…å«æ­£ç¡®çš„Supabaseé…ç½®ï¼š

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 3. åˆå§‹åŒ–Alembic

```bash
# åˆå§‹åŒ–Alembicå¹¶åˆ›å»ºåˆå§‹è¿ç§»
python manage.py init
```

### 4. åº”ç”¨è¿ç§»

```bash
# å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
python manage.py upgrade
```

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### åˆ›å»ºæ–°è¿ç§»

å½“ä½ ä¿®æ”¹äº†SQLAlchemyæ¨¡å‹åï¼Œåˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶ï¼š

```bash
python manage.py migrate "Add new column to products table"
```

### å‡çº§æ•°æ®åº“

```bash
# å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
python manage.py upgrade

# å‡çº§åˆ°æŒ‡å®šç‰ˆæœ¬
python manage.py upgrade abc123
```

### é™çº§æ•°æ®åº“

```bash
# é™çº§åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
python manage.py downgrade -1

# é™çº§åˆ°æŒ‡å®šç‰ˆæœ¬
python manage.py downgrade abc123

# é™çº§åˆ°åŸºç¡€ç‰ˆæœ¬
python manage.py downgrade base
```

### æŸ¥çœ‹è¿ç§»çŠ¶æ€

```bash
# æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬
python manage.py current

# æŸ¥çœ‹è¿ç§»å†å²
python manage.py history
```

## ğŸ”§ å·¥ä½œæµç¨‹

### 1. ä¿®æ”¹æ¨¡å‹

åœ¨ `app/database.py` ä¸­ä¿®æ”¹SQLAlchemyæ¨¡å‹ï¼š

```python
class AmazonProduct(Base):
    __tablename__ = "amazon_products"
    
    # æ·»åŠ æ–°å­—æ®µ
    new_field = Column(String, nullable=True)
    # ... å…¶ä»–å­—æ®µ
```

### 2. ç”Ÿæˆè¿ç§»

```bash
python manage.py migrate "Add new_field to amazon_products"
```

è¿™ä¼šåœ¨ `alembic/versions/` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„è¿ç§»æ–‡ä»¶ã€‚

### 3. æ£€æŸ¥è¿ç§»æ–‡ä»¶

æ‰“å¼€ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œç¡®è®¤SQLè¯­å¥æ­£ç¡®ï¼š

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('amazon_products', sa.Column('new_field', sa.String(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('amazon_products', 'new_field')
    # ### end Alembic commands ###
```

### 4. åº”ç”¨è¿ç§»

```bash
python manage.py upgrade
```

## ğŸ¯ æœ€ä½³å®è·µ

### 1. è¿ç§»å‘½å

ä½¿ç”¨æè¿°æ€§çš„è¿ç§»æ¶ˆæ¯ï¼š

```bash
# âœ… å¥½çš„å‘½å
python manage.py migrate "Add rating_count index to products"
python manage.py migrate "Remove deprecated price_old column"

# âŒ ä¸å¥½çš„å‘½å
python manage.py migrate "update"
python manage.py migrate "fix"
```

### 2. æ£€æŸ¥ç”Ÿæˆçš„è¿ç§»

æ€»æ˜¯æ£€æŸ¥è‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶ï¼Œç¡®ä¿ï¼š
- SQLè¯­å¥æ­£ç¡®
- æ²¡æœ‰é—æ¼çš„æ“ä½œ
- é™çº§æ“ä½œå¯ä»¥æ­£ç¡®å›æ»š

### 3. å¤‡ä»½æ•°æ®

åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿ç§»å‰ï¼ŒåŠ¡å¿…å¤‡ä»½æ•°æ®ï¼š

```bash
# ä½¿ç”¨pg_dumpå¤‡ä»½
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 4. æµ‹è¯•è¿ç§»

åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•å®Œæ•´çš„å‡çº§/é™çº§æµç¨‹ï¼š

```bash
# åº”ç”¨è¿ç§»
python manage.py upgrade

# æµ‹è¯•é™çº§
python manage.py downgrade -1

# é‡æ–°å‡çº§
python manage.py upgrade
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. ç”Ÿäº§ç¯å¢ƒè¿ç§»

- åœ¨ç»´æŠ¤çª—å£æœŸé—´æ‰§è¡Œ
- æå‰å¤‡ä»½æ•°æ®
- å‡†å¤‡å›æ»šè®¡åˆ’
- ç›‘æ§è¿ç§»è¿‡ç¨‹

### 2. å›¢é˜Ÿåä½œ

- è¿ç§»æ–‡ä»¶è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- é¿å…åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªè¡¨ç»“æ„
- å®šæœŸåŒæ­¥è¿ç§»çŠ¶æ€

### 3. æ•°æ®è¿ç§»

å¯¹äºå¤æ‚çš„æ•°æ®è¿ç§»ï¼Œå¯ä»¥åœ¨è¿ç§»æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ï¼š

```python
from alembic import op
import sqlalchemy as sa

def upgrade() -> None:
    # ç»“æ„å˜æ›´
    op.add_column('amazon_products', sa.Column('new_field', sa.String()))
    
    # æ•°æ®è¿ç§»
    connection = op.get_bind()
    connection.execute(
        "UPDATE amazon_products SET new_field = 'default_value' WHERE new_field IS NULL"
    )

def downgrade() -> None:
    op.drop_column('amazon_products', 'new_field')
```

## ğŸ” æ•…éšœæ’é™¤

### 1. è¿ç§»å†²çª

å¦‚æœå‡ºç°è¿ç§»å†²çªï¼Œå¯ä»¥æ‰‹åŠ¨åˆå¹¶ï¼š

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
python manage.py current

# æ‰‹åŠ¨è§£å†³å†²çªåï¼Œæ ‡è®°ä¸ºå·²è§£å†³
python manage.py stamp head
```

### 2. å›æ»šå¤±è´¥

å¦‚æœé™çº§å¤±è´¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨ä¿®å¤ï¼š

```bash
# æŸ¥çœ‹å…·ä½“é”™è¯¯
python manage.py downgrade -1 --sql

# æ‰‹åŠ¨æ‰§è¡ŒSQLåæ›´æ–°ç‰ˆæœ¬
python manage.py stamp <target_revision>
```

### 3. é‡ç½®è¿ç§»

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœéœ€è¦é‡ç½®æ‰€æœ‰è¿ç§»ï¼š

```bash
# åˆ é™¤æ‰€æœ‰è¿ç§»æ–‡ä»¶
rm alembic/versions/*.py

# é‡æ–°åˆå§‹åŒ–
python manage.py init
```

## ğŸ“š å‚è€ƒèµ„æ–™

- [Alembicå®˜æ–¹æ–‡æ¡£](https://alembic.sqlalchemy.org/)
- [SQLAlchemyæ–‡æ¡£](https://docs.sqlalchemy.org/)
- [PostgreSQLæ–‡æ¡£](https://www.postgresql.org/docs/)