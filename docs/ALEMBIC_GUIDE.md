# Alembic 数据库迁移指南

本项目使用Alembic进行数据库版本控制和迁移管理。

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

确保 `.env` 文件中包含正确的Supabase配置：

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 3. 初始化Alembic

```bash
# 初始化Alembic并创建初始迁移
python manage.py init
```

### 4. 应用迁移

```bash
# 升级到最新版本
python manage.py upgrade
```

## 📝 常用命令

### 创建新迁移

当你修改了SQLAlchemy模型后，创建新的迁移文件：

```bash
python manage.py migrate "Add new column to products table"
```

### 升级数据库

```bash
# 升级到最新版本
python manage.py upgrade

# 升级到指定版本
python manage.py upgrade abc123
```

### 降级数据库

```bash
# 降级到上一个版本
python manage.py downgrade -1

# 降级到指定版本
python manage.py downgrade abc123

# 降级到基础版本
python manage.py downgrade base
```

### 查看迁移状态

```bash
# 查看当前数据库版本
python manage.py current

# 查看迁移历史
python manage.py history
```

## 🔧 工作流程

### 1. 修改模型

在 `app/database.py` 中修改SQLAlchemy模型：

```python
class AmazonProduct(Base):
    __tablename__ = "amazon_products"
    
    # 添加新字段
    new_field = Column(String, nullable=True)
    # ... 其他字段
```

### 2. 生成迁移

```bash
python manage.py migrate "Add new_field to amazon_products"
```

这会在 `alembic/versions/` 目录下创建一个新的迁移文件。

### 3. 检查迁移文件

打开生成的迁移文件，确认SQL语句正确：

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('amazon_products', sa.Column('new_field', sa.String(), nullable=True))
    # ### end Alembic commands ###

def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('amazon_products', 'new_field')
    # ### end Alembic commands ###
```

### 4. 应用迁移

```bash
python manage.py upgrade
```

## 🎯 最佳实践

### 1. 迁移命名

使用描述性的迁移消息：

```bash
# ✅ 好的命名
python manage.py migrate "Add rating_count index to products"
python manage.py migrate "Remove deprecated price_old column"

# ❌ 不好的命名
python manage.py migrate "update"
python manage.py migrate "fix"
```

### 2. 检查生成的迁移

总是检查自动生成的迁移文件，确保：
- SQL语句正确
- 没有遗漏的操作
- 降级操作可以正确回滚

### 3. 备份数据

在生产环境应用迁移前，务必备份数据：

```bash
# 使用pg_dump备份
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 4. 测试迁移

在开发环境测试完整的升级/降级流程：

```bash
# 应用迁移
python manage.py upgrade

# 测试降级
python manage.py downgrade -1

# 重新升级
python manage.py upgrade
```

## 🚨 注意事项

### 1. 生产环境迁移

- 在维护窗口期间执行
- 提前备份数据
- 准备回滚计划
- 监控迁移过程

### 2. 团队协作

- 迁移文件要提交到版本控制
- 避免同时修改同一个表结构
- 定期同步迁移状态

### 3. 数据迁移

对于复杂的数据迁移，可以在迁移文件中添加自定义逻辑：

```python
from alembic import op
import sqlalchemy as sa

def upgrade() -> None:
    # 结构变更
    op.add_column('amazon_products', sa.Column('new_field', sa.String()))
    
    # 数据迁移
    connection = op.get_bind()
    connection.execute(
        "UPDATE amazon_products SET new_field = 'default_value' WHERE new_field IS NULL"
    )

def downgrade() -> None:
    op.drop_column('amazon_products', 'new_field')
```

## 🔍 故障排除

### 1. 迁移冲突

如果出现迁移冲突，可以手动合并：

```bash
# 查看当前状态
python manage.py current

# 手动解决冲突后，标记为已解决
python manage.py stamp head
```

### 2. 回滚失败

如果降级失败，可能需要手动修复：

```bash
# 查看具体错误
python manage.py downgrade -1 --sql

# 手动执行SQL后更新版本
python manage.py stamp <target_revision>
```

### 3. 重置迁移

在开发环境中，如果需要重置所有迁移：

```bash
# 删除所有迁移文件
rm alembic/versions/*.py

# 重新初始化
python manage.py init
```

## 📚 参考资料

- [Alembic官方文档](https://alembic.sqlalchemy.org/)
- [SQLAlchemy文档](https://docs.sqlalchemy.org/)
- [PostgreSQL文档](https://www.postgresql.org/docs/)